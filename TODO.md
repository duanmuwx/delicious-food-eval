# TODO - 待办功能

## P0：排行榜按餐次筛选（功能补全）
- [ ] 排行榜页面增加早餐/午餐/晚餐筛选（当前只有周/月切换，不区分餐次）

## P1：菜品库复用优化（降低管理成本）

> **背景**：每天 3 餐 × 4~5 道 ≈ 12~15 道菜需要录入，且菜品高度重复（周期约 3~4 周）。
> 核心目标：将每日录入从"逐个手动填写"变为"勾选历史菜品批量导入"，大幅降低操作成本。

### P1-1：批量复用历史菜品（核心功能）⭐

**交互流程**：选日期 + 选餐次 → 点击「从历史导入」→ 弹出半屏弹窗 → 勾选菜品 → 确认批量添加

**弹窗设计**：
- 顶部搜索框，输入关键字实时过滤
- 列表自动按当前所选餐次过滤（选了午餐只展示历史午餐菜品）
- 按最近出现时间降序排列（最近 3~4 周的菜排在最前面，基本覆盖需求）
- 每项展示：菜品名 + 历史均分 + 出现次数 + 历史图片缩略图
- 底部固定栏显示「已选 N 道」+「确认添加」按钮
- 勾选后批量添加，自动复用历史图片（引用同一个 imageFileId，不重复上传）

**后端变更**：
- [ ] 新建云函数 `searchDishHistory`：接收 `keyword`（可选）和 `meal`（餐次），返回去重后的历史菜品列表，每项包含 `name`、`meal`、`lastImageFileId`（最近一次的图片）、`totalCount`（出现次数）、`overallAvgScore`（历史均分，所有同名菜品评分的加权平均）、`lastDate`（最近出现日期），按 `lastDate` 降序排列

**前端变更**：
- [ ] admin 页面新增「从历史导入」按钮（在添加菜品表单下方）
- [ ] 实现半屏弹窗：搜索框 + 可勾选的历史菜品列表 + 底部已选计数和确认按钮
- [ ] 确认后调用 `addDish` 批量添加所选菜品（循环调用或扩展 addDish 支持批量）
- [ ] 移除现有的「复用历史」独立搜索框（合并到批量导入弹窗中，避免功能重复）

### 

- [ ] 添加菜品成功后，保留餐次和日期选择，仅清空菜名和图片，方便连续录入新菜

### P1-3：周菜单管理视图（进度看板）

> **场景**：管理员从办公系统获取一周菜品表格，需要对照表格逐天逐餐录入系统。
> 周视图的核心价值是"进度看板 + 快捷入口"，而非复杂的拖拽排菜单。

**交互设计**：
- 新页面 `pages/weekly/weekly`，入口在 admin 页面顶部
- 展示周一到周日 × 早/午/晚的网格视图
- 每个格子显示已录入菜品数量（如「午餐 5 道」），未录入的格子显示为空状态
- 点击某个格子 → 跳转到 admin 页面并自动设定对应日期+餐次，触发批量复用流程
- 支持左右滑动切换周次

**变更**：
- [ ] 新建页面 `pages/weekly/weekly`（wxml + wxss + js + json）
- [ ] admin 页面顶部增加「周菜单视图」入口
- [ ] admin 页面支持从 URL 参数接收 `date` 和 `meal`，自动设定表单状态

## P2：菜单预告分享（增长核心杠杆）
- [ ] 管理员菜单分享：录完当日菜单后，支持一键分享到微信群
  - 分享文案自动生成：「今日午餐已更新，共 X 道菜，N 道高分菜品回归！」
  - 落地页为首页，自动定位到对应餐次
- [ ] `onShareAppMessage` 实现：自定义分享标题 + 缩略图 + 路径参数
- [ ] 分享落地体验：被分享者点开直接看到对应菜品/菜单，不强制登录拦截

## P3：用户补充图片（提升内容丰富度）

> **背景**：管理员提前录入菜单时菜品尚未出锅，无法拍照；用户在食堂现场恰好能补充实物图片。
> 核心目标：通过 UGC 众包补全菜品图片，减轻管理员图片管理负担，同时提升内容丰富度。

**设计决策**：
- 单图模型：每道菜只保留一张主图（复用现有 `imageFileId` 字段），用户上传直接填充空位，不做多图画廊
- 独立于评分：用户无需打分即可上传图片，降低参与门槛
- 仅无图菜品开放上传：已有图片的菜品不允许用户覆盖（管理员可通过后台替换）
- 被动审核：不设审核队列，管理员在现有管理页面发现不合适图片时直接删除即可

### 数据库变更

- [ ] `dishes` 集合新增字段：`imageContributor`（userId）、`imageContributorName`（昵称，冗余存储用于展示）

### P3-1：用户上传图片（核心功能）⭐

**上传入口**：
- 评分页（主入口）：菜品无图时，在评分表单上方展示引导区「这道菜还没有图片，拍一张吧」+ 相机图标，点击触发拍照/选图
- dish-card 组件（辅助入口）：无图菜品卡片的占位图区域显示相机图标 + 引导文案，点击跳转评分页

**上传逻辑**：
- 用户选择图片后上传至云存储，路径 `dishes/{timestamp}-{random}.jpg`
- 调用云函数更新 dish 记录的 `imageFileId`、`imageContributor`、`imageContributorName`

**后端变更**：
- [ ] 新建云函数 `uploadDishImage`：接收 `dishId` + `imageFileId`，校验菜品当前无图后写入，同时记录 `imageContributor` 和 `imageContributorName`

**前端变更**：
- [ ] 评分页（`pages/rate/rate`）：菜品无图时展示拍照引导区，点击调用 `wx.chooseMedia` 选图并上传
- [ ] dish-card 组件：无图状态下图片占位区增加相机图标和引导文案，点击跳转评分页

### P3-2：首图贡献者标识

- [ ] `dish-comments` 页面菜品头部区域：有 `imageContributor` 时显示「图片由 xxx 提供」
- [ ] 评分页菜品图片下方：有贡献者时小字展示贡献者昵称

### P3-3：管理员图片管理（安全兜底）

- [ ] 管理员在 `admin` 页面编辑菜品时，可删除/替换用户上传的图片（复用现有编辑逻辑，删除时同时清空 `imageContributor` 和 `imageContributorName`）

## P4：单品分享卡片
- [ ] dish-card 组件增加分享按钮
- [ ] 评分完成后引导分享：用户刚打完分时触发分享引导
- [ ] 分享文案根据分数区间差异化：
  - 4.5+ →「今天必吃」
  - 4.0-4.4 →「值得一试」
  - 3.5-3.9 →「大家觉得还行」
  - 3.5 以下 →「来帮它翻身」
- [ ] 分享路径带 `dishId` + `date`，落地到菜品详情页
- [ ] （二期）Canvas 海报 + 小程序码生成，支持保存图片到相册分享到朋友圈

## P5：「本周值得期待」标记
- [x] 周菜单录入后，自动识别历史高分菜品（4.5+）并标记
- [x] 首页醒目展示高分回归菜品（如角标「历史好评」）

## 评论互动功能
- [ ] 评论点赞功能：用户可以对其他用户的评论点赞
- [ ] 评论回复功能：用户可以回复其他用户的评论

### 数据库变更（评论互动所需）
- [ ] 新建 `comment_likes` 集合：`commentId`, `userId`, `createdAt`
- [ ] 新建 `comment_replies` 集合：`commentId`, `userId`, `content`, `createdAt`
- [ ] 新建对应的云函数：`likeComment`, `replyComment`, `getCommentReplies`

## 其他功能增强
- [ ] 评论展示增强：让用户能看到其他人的评论（短评/弹幕风格），提升社交属性
- [ ] 轻量互动：添加「踩/赞」零成本操作，降低参与门槛
- [ ] 订阅消息推送：每天午饭前推送今日菜单，拉活用户
- [ ] 个人数据成就：「我的」页面展示「已评价 XX 道菜」「本周最活跃美食家」等成就
- [ ] 分享数据埋点：追踪分享次数、分享渠道、通过分享进入的新用户数
- [ ] 朋友圈分享：`onShareTimeline` 支持（仅 Android）

## 运营策略（无需开发）
- [ ] 拉 5-10 个种子用户先体验，积累初始内容
- [ ] 每周在公司群/食堂群发「本周最佳菜品 TOP3」排行榜截图引流
- [ ] 推广话术主打吐槽心理：「来给今天的菜打个分，看看是不是就你觉得难吃」
- [ ] 尝试与食堂管理员建立联系，形成「评价→改进」正向循环
