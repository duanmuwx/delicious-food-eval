<view class="container">
  <!-- 菜品信息头部 -->
  <view wx:if="{{dish}}" class="dish-header card">
    <image
      class="dish-image"
      wx:if="{{dish.imageFileId}}"
      src="{{dish.imageFileId}}"
      mode="aspectFill"
    />
    <view class="dish-image dish-image-placeholder" wx:else>
      <text class="placeholder-text">暂无图片</text>
    </view>
    <view class="dish-info">
      <text class="dish-name">{{dish.name}}</text>
      <text wx:if="{{dish.imageContributorName}}" class="contributor-text">图片由 {{dish.imageContributorName}} 提供</text>
      <view class="dish-stats">
        <star-rating value="{{dish.avgScore}}" readonly="{{true}}" size="28" />
        <text class="dish-score">{{dish.avgScoreText}}分</text>
      </view>
      <text class="dish-count">{{dish.ratingCount}}人评价</text>
    </view>
  </view>

  <!-- 加载中 -->
  <view wx:if="{{loading}}" class="loading-wrap">
    <text class="loading-text">加载中...</text>
  </view>

  <!-- 评论列表 -->
  <block wx:else>
    <view class="section-title">全部评论 ({{comments.length}})</view>

    <view wx:if="{{comments.length > 0}}" class="comment-list">
      <view
        class="comment-item card"
        wx:for="{{comments}}"
        wx:key="_id"
      >
        <view class="comment-header">
          <view class="comment-user">
            <image
              class="user-avatar"
              wx:if="{{item.avatarUrl}}"
              src="{{item.avatarUrl}}"
              mode="aspectFill"
            />
            <view class="user-avatar user-avatar-default" wx:else>
              <text class="avatar-text">{{item.nickName[0] || '匿'}}</text>
            </view>
            <text class="user-name">{{item.nickName}}</text>
          </view>
          <text class="comment-date">{{item.dateText}}</text>
        </view>
        <view class="comment-body">
          <view class="comment-stars">
            <view
              wx:for="{{[0,1,2,3,4]}}"
              wx:key="*this"
              wx:for-item="idx"
              class="comment-star-wrapper"
            >
              <view class="comment-star-half comment-star-left {{idx + 0.5 <= item.score ? 'active' : ''}}">★</view>
              <view class="comment-star-half comment-star-right {{idx + 1 <= item.score ? 'active' : ''}}">★</view>
            </view>
            <text class="comment-score">{{item.score}}分</text>
          </view>
          <text wx:if="{{item.comment}}" class="comment-text">{{item.comment}}</text>
          <view class="comment-footer">
            <view
              class="like-btn {{item.liked ? 'liked' : ''}} {{item.isOwn ? 'like-btn-disabled' : ''}}"
              data-id="{{item._id}}"
              data-index="{{index}}"
              bindtap="onToggleLike"
            >
              <text class="like-icon">{{item.liked ? '❤' : '♡'}}</text>
              <text class="like-count" wx:if="{{item.likeCount > 0}}">{{item.likeCount}}</text>
            </view>
          </view>
        </view>
      </view>
    </view>
    <empty-state wx:else message="暂无评论" />
  </block>
</view>
