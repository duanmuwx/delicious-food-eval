<view class="container">
  <!-- 添加菜品表单 -->
  <view class="form-section card">
    <view class="section-title">添加菜品</view>

    <!-- 菜名输入 + 历史搜索 -->
    <view class="form-item">
      <text class="form-label">菜名</text>
      <input
        class="form-input"
        placeholder="输入菜名（可搜索历史菜品）"
        value="{{dishName}}"
        bindinput="onNameInput"
      />
    </view>

    <!-- 历史菜品搜索提示 -->
    <view class="form-item" style="position: relative;">
      <text class="form-label">复用历史</text>
      <input
        class="form-input"
        placeholder="搜索历史菜品名"
        value="{{historyKeyword}}"
        bindinput="onHistoryInput"
      />
      <view wx:if="{{showHistory && historyResults.length > 0}}" class="history-dropdown">
        <view
          class="history-option"
          wx:for="{{historyResults}}"
          wx:key="_id"
          data-name="{{item.name}}"
          bindtap="onPickHistory"
        >
          <text>{{item.name}}</text>
          <text class="history-date-hint">{{item.date}}</text>
        </view>
      </view>
    </view>

    <!-- 餐次选择 -->
    <view class="form-item">
      <text class="form-label">餐次</text>
      <picker mode="selector" range="{{mealOptions}}" value="{{mealIndex}}" bindchange="onMealChange">
        <view class="form-picker">{{mealOptions[mealIndex]}}</view>
      </picker>
    </view>

    <!-- 日期选择 -->
    <view class="form-item">
      <text class="form-label">日期</text>
      <picker mode="date" value="{{date}}" bindchange="onDateChange">
        <view class="form-picker">{{date}}</view>
      </picker>
    </view>

    <!-- 图片上传 -->
    <view class="form-item">
      <text class="form-label">菜品图片</text>
      <view class="image-upload-area">
        <view wx:if="{{imageFilePath}}" class="image-preview-wrap">
          <image class="image-preview" src="{{imageFilePath}}" mode="aspectFill" />
          <view class="image-remove" bindtap="onRemoveImage">✕</view>
        </view>
        <view wx:else class="image-upload-btn" bindtap="onChooseImage">
          <text class="upload-icon">+</text>
          <text class="upload-text">拍照/选图</text>
        </view>
      </view>
    </view>

    <button
      class="btn-primary submit-btn"
      bindtap="onSubmit"
      disabled="{{submitting}}"
    >
      {{submitting ? '添加中...' : '添加菜品'}}
    </button>
  </view>

  <!-- 当日菜品列表 -->
  <view class="section">
    <view class="section-title">{{date}} 已添加菜品</view>
    <view wx:if="{{loading}}" class="loading-wrap">
      <text class="loading-text">加载中...</text>
    </view>
    <block wx:else>
      <block wx:if="{{todayDishes.length > 0}}">
        <dish-card
          wx:for="{{todayDishes}}"
          wx:key="_id"
          dish="{{item}}"
          showAction="{{false}}"
          showDelete="{{true}}"
          bind:dishtap="onDishTap"
          bind:delete="onDeleteDish"
          bind:edit="onEditDish"
        />
      </block>
      <empty-state wx:else message="暂未添加菜品" />
    </block>
  </view>

  <!-- 编辑菜品弹窗 -->
  <view class="modal-mask" wx:if="{{showEditModal}}" bindtap="onCloseEdit">
    <view class="modal-content card" catchtap>
      <view class="section-title">编辑菜品：{{editDish.name}}</view>

      <view class="form-item">
        <text class="form-label">菜品描述</text>
        <textarea
          class="form-textarea"
          placeholder="输入菜品描述（可选）"
          value="{{editDescription}}"
          bindinput="onEditDescInput"
          maxlength="200"
          auto-height
        />
      </view>

      <view class="form-item">
        <text class="form-label">菜品图片</text>
        <view class="image-upload-area">
          <view wx:if="{{editImagePath}}" class="image-preview-wrap">
            <image class="image-preview" src="{{editImagePath}}" mode="aspectFill" />
            <view class="image-remove" bindtap="onEditRemoveImage">✕</view>
          </view>
          <view wx:else class="image-upload-btn" bindtap="onEditChooseImage">
            <text class="upload-icon">+</text>
            <text class="upload-text">拍照/选图</text>
          </view>
        </view>
      </view>

      <view class="modal-btns">
        <button class="btn-cancel" bindtap="onCloseEdit">取消</button>
        <button class="btn-primary" bindtap="onSubmitEdit" disabled="{{editSubmitting}}">
          {{editSubmitting ? '保存中...' : '保存'}}
        </button>
      </view>
    </view>
  </view>
</view>
