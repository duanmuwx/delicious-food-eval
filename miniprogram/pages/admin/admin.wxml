<view class="container">
  <!-- 周菜单进度入口 -->
  <view class="weekly-entry" bindtap="onGoWeekly">
    <text class="weekly-entry-text">周菜单进度</text>
    <text class="weekly-entry-arrow">▶</text>
  </view>

  <!-- 添加菜品表单 -->
  <view class="form-section card">
    <view class="section-title">添加菜品</view>

    <!-- 菜名输入 -->
    <view class="form-item">
      <text class="form-label">菜名</text>
      <input
        class="form-input"
        placeholder="输入菜名"
        value="{{dishName}}"
        bindinput="onNameInput"
      />
    </view>

    <!-- 餐次选择 -->
    <view class="form-item">
      <text class="form-label">餐次</text>
      <picker mode="selector" range="{{mealOptions}}" value="{{mealIndex}}" bindchange="onMealChange">
        <view class="form-picker">{{mealOptions[mealIndex]}}</view>
      </picker>
    </view>

    <!-- 日期选择 -->
    <view class="form-item">
      <text class="form-label">日期</text>
      <picker mode="date" value="{{date}}" bindchange="onDateChange">
        <view class="form-picker">{{date}}</view>
      </picker>
    </view>

    <!-- 图片上传 -->
    <view class="form-item">
      <text class="form-label">菜品图片</text>
      <view class="image-upload-area">
        <view wx:if="{{imageFilePath}}" class="image-preview-wrap">
          <image class="image-preview" src="{{imageFilePath}}" mode="aspectFill" />
          <view class="image-remove" bindtap="onRemoveImage">✕</view>
        </view>
        <view wx:else class="image-upload-btn" bindtap="onChooseImage">
          <text class="upload-icon">+</text>
          <text class="upload-text">拍照/选图</text>
        </view>
      </view>
    </view>

    <button
      class="btn-primary submit-btn"
      bindtap="onSubmit"
      disabled="{{submitting}}"
    >
      {{submitting ? '添加中...' : '添加菜品'}}
    </button>

    <button class="btn-outline submit-btn" bindtap="onOpenImport">从历史导入</button>
  </view>

  <!-- 当日菜品列表（按餐次分组） -->
  <view class="section">
    <view class="section-title">{{date}} 已添加菜品</view>

    <view wx:if="{{loading}}" class="loading-wrap">
      <text class="loading-text">加载中...</text>
    </view>
    <block wx:else>
      <block wx:if="{{todayDishes.length > 0}}">
        <view class="meal-group" wx:for="{{mealGroups}}" wx:key="meal" wx:for-item="group">
          <view class="meal-group-header">
            <text class="meal-group-title">{{group.label}}（{{group.dishes.length}}）</text>
            <button
              wx:if="{{group.dishes.length > 0}}"
              class="meal-group-share-btn"
              open-type="share"
              data-meal="{{group.meal}}"
              bindtap="onShareMeal"
            >分享</button>
          </view>
          <block wx:if="{{group.dishes.length > 0}}">
            <dish-card
              wx:for="{{group.dishes}}"
              wx:key="_id"
              dish="{{item}}"
              showAction="{{false}}"
              showDelete="{{true}}"
              bind:dishtap="onDishTap"
              bind:delete="onDeleteDish"
              bind:edit="onEditDish"
            />
          </block>
          <view wx:else class="meal-group-empty">
            <text class="meal-group-empty-text">暂无菜品</text>
          </view>
        </view>
      </block>
      <empty-state wx:else message="暂未添加菜品" />
    </block>
  </view>

  <!-- 编辑菜品弹窗 -->
  <modal show="{{showEditModal}}" position="center" bind:close="onCloseEdit">
    <view class="section-title">编辑菜品：{{editDish.name}}</view>

    <view class="form-item">
      <text class="form-label">菜品描述</text>
      <textarea
        class="form-textarea"
        placeholder="输入菜品描述（可选）"
        value="{{editDescription}}"
        bindinput="onEditDescInput"
        maxlength="200"
        auto-height
      />
    </view>

    <view class="form-item">
      <text class="form-label">菜品图片</text>
      <view class="image-upload-area">
        <view wx:if="{{editImagePath}}" class="image-preview-wrap">
          <image class="image-preview" src="{{editImagePath}}" mode="aspectFill" />
          <view class="image-remove" bindtap="onEditRemoveImage">✕</view>
        </view>
        <view wx:else class="image-upload-btn" bindtap="onEditChooseImage">
          <text class="upload-icon">+</text>
          <text class="upload-text">拍照/选图</text>
        </view>
      </view>
    </view>

    <view class="modal-btns">
      <button class="btn-secondary" bindtap="onCloseEdit">取消</button>
      <button class="btn-primary" bindtap="onSubmitEdit" disabled="{{editSubmitting}}">
        {{editSubmitting ? '保存中...' : '保存'}}
      </button>
    </view>
  </modal>

  <!-- 历史导入弹窗 -->
  <modal show="{{showImportPopup}}" position="bottom" bind:close="onCloseImport">
    <view class="import-header">
      <view class="section-title">从历史导入（{{mealOptions[mealIndex]}}）</view>
      <view class="import-close" bindtap="onCloseImport">✕</view>
    </view>

    <input
      class="form-input import-search"
      placeholder="搜索菜品名"
      value="{{importKeyword}}"
      bindinput="onImportSearch"
    />

    <scroll-view class="import-list" scroll-y>
      <view wx:if="{{importLoading}}" class="loading-wrap">
        <text class="loading-text">加载中...</text>
      </view>
      <block wx:elif="{{importList.length > 0}}">
        <view
          class="import-item {{importSelected[index] ? 'import-item-selected' : ''}}"
          wx:for="{{importList}}"
          wx:key="name"
          data-idx="{{index}}"
          bindtap="onToggleImportItem"
        >
          <view class="import-check">{{importSelected[index] ? '☑' : '☐'}}</view>
          <image
            wx:if="{{item.lastImageFileId}}"
            class="import-thumb"
            src="{{item.lastImageFileId}}"
            mode="aspectFill"
          />
          <view class="import-info">
            <text class="import-name">{{item.name}}</text>
            <text class="import-date">最近：{{item.lastDate}}</text>
          </view>
        </view>
      </block>
      <empty-state wx:else message="暂无历史菜品" />
    </scroll-view>

    <view class="import-footer">
      <text class="import-count">已选 {{importSelectedCount}} 道</text>
      <button
        class="btn-primary import-confirm-btn"
        bindtap="onConfirmImport"
        disabled="{{importSubmitting || importSelectedCount === 0}}"
      >
        {{importSubmitting ? '添加中...' : '确认添加'}}
      </button>
    </view>
  </modal>
</view>
